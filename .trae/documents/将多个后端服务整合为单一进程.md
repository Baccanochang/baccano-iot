# 将多个后端服务整合为单一进程

## 现状分析
目前项目包含多个独立的后端服务，每个服务都有自己的可执行文件：
- alert-center
- api-gateway
- asset-manager
- data-store
- device-connect
- device-gateway
- device-manager
- rule-engine

项目中已有 `unified-server` 目录，是一个初步的整合尝试，但尚未完全集成所有现有服务。

## 整合目标
1. 将所有后端服务合并为单一可执行文件
2. 统一HTTP框架，使用Gin作为主框架
3. 整合所有服务的API路由
4. 统一配置管理
5. 支持优雅启动和关闭
6. 保持代码的可维护性和扩展性

## 实现步骤

### 1. 设计主应用结构
- 基于现有的 `unified-server` 结构进行扩展
- 创建统一的应用配置管理
- 实现服务初始化和生命周期管理

### 2. 整合各个服务

#### 2.1 API网关服务
- 将 `api-gateway` 的路由和处理函数迁移到主应用
- 整合设备管理、产品管理等API

#### 2.2 设备管理服务
- 整合 `device-manager` 的设备管理功能
- 迁移设备CRUD、状态管理等API

#### 2.3 资产管理服务
- 整合 `asset-manager` 的资产管理功能
- 迁移资产CRUD API

#### 2.4 告警中心服务
- 整合 `alert-center` 的告警功能
- 迁移告警规则、告警推送等API

#### 2.5 数据存储服务
- 整合 `data-store` 的数据存储功能
- 提供统一的数据访问接口

#### 2.6 设备连接服务
- 整合 `device-connect` 和 `device-gateway` 的连接管理功能
- 支持MQTT、CoAP等协议

#### 2.7 规则引擎服务
- 整合 `rule-engine` 的规则处理功能
- 支持规则创建、执行和监控

### 3. 统一依赖管理
- 创建统一的 `go.mod` 文件
- 管理所有服务的依赖
- 确保依赖版本兼容

### 4. 实现统一配置
- 支持环境变量和配置文件
- 为每个服务提供独立的配置选项
- 实现配置热加载（可选）

### 5. 测试和验证
- 确保所有API路由正常工作
- 验证服务间通信正常
- 测试启动和关闭流程
- 验证各服务功能完整性

## 预期效果
- 减少部署复杂性，只需部署一个可执行文件
- 简化开发和测试流程
- 提高服务间通信效率
- 降低资源消耗
- 便于统一监控和管理

## 风险评估
1. **依赖冲突**：不同服务可能使用不同版本的依赖，需要仔细管理
2. **性能问题**：单一进程可能存在性能瓶颈，需要进行性能测试
3. **故障隔离**：单一进程中一个服务故障可能影响其他服务，需要实现良好的错误处理
4. **代码复杂度**：整合后代码量增加，需要良好的模块化设计

## 解决方案
- 使用依赖注入管理服务间依赖
- 实现服务级别的错误隔离
- 采用模块化设计，保持代码清晰
- 进行性能测试和优化
- 实现详细的日志记录和监控

## 输出
- 单一可执行文件 `baccano-iot-server`
- 统一的配置文件格式
- 完整的API文档
- 测试用例和部署脚本